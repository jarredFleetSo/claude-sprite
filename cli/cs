#!/usr/bin/env bash
set -euo pipefail

# =============================================================================
# cs — Claude Sprite CLI
# =============================================================================
# One command to attach to your remote Claude Code workspace.
# All subcommands wrap the `sprite` CLI for convenience.
# =============================================================================

CS_VERSION="0.1.0"
CS_CONFIG_DIR="${HOME}/.config/cs"
CS_CONFIG_FILE="${CS_CONFIG_DIR}/config"

# ---------------------------------------------------------------------------
# Defaults (overridden by config file)
# ---------------------------------------------------------------------------
CS_SPRITE_NAME="${CS_SPRITE_NAME:-}"
CS_ORG="${CS_ORG:-}"
CS_TMUX_SESSION="${CS_TMUX_SESSION:-workspace}"

# ---------------------------------------------------------------------------
# Colors
# ---------------------------------------------------------------------------
if [[ -t 1 ]] && [[ -z "${NO_COLOR:-}" ]]; then
    _G="\033[0;32m" _Y="\033[0;33m" _R="\033[0;31m"
    _C="\033[0;36m" _B="\033[1m"    _0="\033[0m"
else
    _G="" _Y="" _R="" _C="" _B="" _0=""
fi

# ---------------------------------------------------------------------------
# Helpers
# ---------------------------------------------------------------------------
info()  { printf "${_G}>${_0} %s\n" "$*"; }
warn()  { printf "${_Y}!${_0} %s\n" "$*" >&2; }
err()   { printf "${_R}x${_0} %s\n" "$*" >&2; }
die()   { err "$@"; exit 1; }

require_sprite_cli() {
    command -v sprite &>/dev/null || die "sprite CLI not found. Install it from https://sprites.dev"
}

load_config() {
    if [[ -f "$CS_CONFIG_FILE" ]]; then
        # shellcheck source=/dev/null
        source "$CS_CONFIG_FILE"
    fi
}

save_config() {
    mkdir -p "$CS_CONFIG_DIR"
    cat > "$CS_CONFIG_FILE" <<EOF
# cs configuration — generated by cs setup
CS_SPRITE_NAME="${CS_SPRITE_NAME}"
CS_ORG="${CS_ORG}"
CS_TMUX_SESSION="${CS_TMUX_SESSION}"
EOF
    chmod 600 "$CS_CONFIG_FILE"
    info "Config saved to ${CS_CONFIG_FILE}"
}

require_config() {
    if [[ -z "$CS_SPRITE_NAME" ]]; then
        die "Sprite name not configured. Run 'cs setup' first."
    fi
}

sprite_args() {
    local args="-s ${CS_SPRITE_NAME}"
    if [[ -n "$CS_ORG" ]]; then
        args+=" -o ${CS_ORG}"
    fi
    echo "$args"
}

# ---------------------------------------------------------------------------
# Subcommands
# ---------------------------------------------------------------------------

cmd_attach() {
    require_sprite_cli
    require_config
    info "Attaching to tmux session '${CS_TMUX_SESSION}' on ${CS_SPRITE_NAME}..."
    # Best-effort session touch — don't block attach if dashboard is down
    # shellcheck disable=SC2046
    sprite exec $(sprite_args) -- \
        curl -s -X POST "http://localhost:8888/api/sessions/${CS_TMUX_SESSION}/touch" \
        -d client=terminal &>/dev/null &
    # shellcheck disable=SC2046
    exec sprite exec $(sprite_args) -tty -- tmux attach-session -A -t "$CS_TMUX_SESSION"
}

cmd_status() {
    require_sprite_cli
    require_config
    info "Checking status of ${CS_SPRITE_NAME}..."

    # Sprite status
    # shellcheck disable=SC2046
    sprite exec $(sprite_args) -tty -- bash -c '
        echo "=== Sprite Status ==="
        echo "Hostname: $(hostname)"
        echo "Uptime:   $(uptime -p 2>/dev/null || uptime)"
        echo ""
        echo "=== tmux Sessions ==="
        tmux list-sessions 2>/dev/null || echo "(no sessions)"
        echo ""
        echo "=== Services ==="
        for port in 7681 8080 8888; do
            name="unknown"
            case $port in
                7681) name="ttyd" ;;
                8080) name="code-server" ;;
                8888) name="dashboard" ;;
            esac
            if ss -tln 2>/dev/null | grep -q ":${port} " 2>/dev/null; then
                printf "  %-14s :%s  ✓ listening\n" "$name" "$port"
            else
                printf "  %-14s :%s  - not running\n" "$name" "$port"
            fi
        done
    '
}

cmd_start() {
    require_sprite_cli
    require_config
    info "Waking Sprite ${CS_SPRITE_NAME}..."
    # exec triggers wake on Sprites.dev
    # shellcheck disable=SC2046
    sprite exec $(sprite_args) -- echo "Sprite is awake."
    info "Done."
}

cmd_stop() {
    require_sprite_cli
    require_config
    info "Requesting checkpoint for ${CS_SPRITE_NAME}..."
    # shellcheck disable=SC2046
    sprite stop $(sprite_args) 2>/dev/null || warn "sprite stop not available — Sprite will idle automatically."
    info "Done."
}

cmd_proxy() {
    require_sprite_cli
    require_config
    local ports="${1:-8888 7681 8080}"
    info "Proxying ports: ${ports}"
    info "Dashboard → http://localhost:8888"
    info "Terminal  → http://localhost:7681"
    info "Editor    → http://localhost:8080"
    info "Press Ctrl-C to stop."
    # shellcheck disable=SC2046,SC2086
    exec sprite proxy $(sprite_args) $ports
}

cmd_url() {
    require_sprite_cli
    require_config
    # shellcheck disable=SC2046
    sprite exec $(sprite_args) -- bash -c '
        echo "=== Access URLs ==="
        if [[ -f /etc/default/workspace ]]; then
            source /etc/default/workspace
        fi
        if [[ -n "${TERM_HOSTNAME:-}" ]]; then
            echo "Terminal:  https://${TERM_HOSTNAME}"
        fi
        if [[ -n "${CODE_HOSTNAME:-}" ]]; then
            echo "Editor:    https://${CODE_HOSTNAME}"
        fi
        if [[ -n "${DASH_HOSTNAME:-}" ]]; then
            echo "Dashboard: https://${DASH_HOSTNAME}"
        fi
        echo ""
        echo "Or use: cs proxy"
        echo "  Dashboard → http://localhost:8888"
        echo "  Terminal  → http://localhost:7681"
        echo "  Editor    → http://localhost:8080"
    '
}

cmd_setup() {
    printf "${_B}cs setup${_0} — Configure your Claude Sprite workspace\n\n"

    # Sprite name
    local default_name="${CS_SPRITE_NAME:-claude-code}"
    printf "Sprite name [${_C}${default_name}${_0}]: "
    read -r input
    CS_SPRITE_NAME="${input:-$default_name}"

    # Organization
    local default_org="${CS_ORG:-}"
    printf "Organization (leave blank if none) [${_C}${default_org}${_0}]: "
    read -r input
    CS_ORG="${input:-$default_org}"

    # tmux session
    local default_session="${CS_TMUX_SESSION:-workspace}"
    printf "tmux session name [${_C}${default_session}${_0}]: "
    read -r input
    CS_TMUX_SESSION="${input:-$default_session}"

    echo ""
    save_config

    echo ""
    info "Setup complete. Try running:"
    echo "  cs          # attach to workspace"
    echo "  cs status   # check Sprite status"
    echo "  cs proxy    # proxy ports for local browser access"
}

cmd_help() {
    cat <<EOF
${_B}cs${_0} — Claude Sprite CLI v${CS_VERSION}

${_B}Usage:${_0}
  cs                  Attach to the remote tmux workspace session
  cs status           Show Sprite status, tmux sessions, and services
  cs start            Wake the Sprite VM
  cs stop             Checkpoint and idle the Sprite VM
  cs proxy [ports]    Proxy remote ports to localhost (default: 8888 7681 8080)
  cs url              Print access URLs (tunnel and proxy)
  cs setup            Interactive first-time configuration
  cs help             Show this help message
  cs version          Show version

${_B}Configuration:${_0}
  ${CS_CONFIG_FILE}

${_B}Examples:${_0}
  cs                  # Jump straight into Claude Code
  cs proxy            # Then open http://localhost:8888 on your phone
  cs status           # Quick health check

EOF
}

cmd_version() {
    echo "cs ${CS_VERSION}"
}

# ---------------------------------------------------------------------------
# Main dispatch
# ---------------------------------------------------------------------------
load_config

case "${1:-}" in
    ""|attach)   cmd_attach ;;
    status)      cmd_status ;;
    start)       cmd_start ;;
    stop)        cmd_stop ;;
    proxy)       shift; cmd_proxy "$*" ;;
    url)         cmd_url ;;
    setup)       cmd_setup ;;
    help|--help|-h) cmd_help ;;
    version|--version|-v) cmd_version ;;
    *)           err "Unknown command: $1"; echo ""; cmd_help; exit 1 ;;
esac
